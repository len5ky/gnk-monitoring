# Deployment Guide for Monitoring Stack

This guide provides the steps to deploy the self-hosted monitoring stack (Loki, Promtail, Prometheus, Grafana, Caddy, connectivity checker) on a new host machine.

## 1. Prerequisites

- **Docker & Docker Compose**: Ensure `docker` and `docker-compose` (or `docker compose`) are installed on the new host.
- **Project Files**: The `monitoring` project directory is required.
- **Public IP**: You need a static public IP address for the new host.

## 2. Initial Setup

### Step 2.1: Copy Project Files
Transfer the entire `monitoring` directory to the new host. You can use `scp`, `rsync`, or clone it from your version control system.

Example using `scp` (run from your local machine):
```bash
scp -r /path/to/your/monitoring user@<NEW_HOST_IP>:/path/to/destination/
```

### Step 2.2: Configure Environment
Navigate into the `monitoring` directory on the new host.

Create an environment configuration file by copying the template.
```bash
cp env.monitoring.template env.monitoring
```
Now, edit `env.monitoring` and set the following variables:
- `GF_SERVER_ROOT_IP`: **Crucially, replace with the new host's actual public IP address.**
- `HOST_INSTANCE_ID`: Unique identifier for the monitoring host (default: `monitoring-host`).
- `GRAFANA_ADMIN_PASSWORD`: Set a secure password for the Grafana admin user.
- `LOKI_INGEST_PASSWORD`: Set a secure password for Loki ingestion (plaintext - hash auto-generated).
- `PROMETHEUS_PASSWORD`: Set a secure password for Prometheus remote_write (plaintext - hash auto-generated).

**Note**: Password hashes are automatically generated by `./scripts/start.sh` on first run. You only need to provide plaintext passwords.
### Step 2.3: Configure Connectivity Inventory

The connectivity checker reads an inventory and profiles. Copy the examples to a mutable location (e.g., `connectivity-checker/config`) and update them with your nodes and templates. The host stack mounts this directory read-only.

### Step 2.3: Generate TLS Certificate for New IP
The stack uses a self-signed TLS certificate for Caddy to provide HTTPS. You must generate a new one matching the new host's IP.

Run the following command, replacing `<NEW_HOST_IP>` with your actual public IP:
./scripts/create_cert.sh

### Step 2.4: Update Caddyfile
The `Caddyfile` does not need changes as it's configured to listen on all interfaces. The certificate generation in the previous step is sufficient.

### Step 2.5: Set Data Directory Permissions
Grafana and Loki containers run with dedicated non-root users. To prevent permission errors on startup, you must set the correct ownership for the host directories they use for data storage.

Run the following commands:
```bash
sudo chown -R 472:472 ./data/grafana
sudo chown -R 10001:10001 ./data/loki
```

## 3. Deploy the Stack

With configuration complete, you can start all services using the provided script:
```bash
./scripts/start.sh
```
This command will pull the necessary Docker images and start all containers in the background.

## 4. Verification

### Step 4.1: Check Container Status
Check that all containers are running and healthy:
```bash
./scripts/status.sh
```
You should see `grafana`, `loki`, `prometheus`, `promtail`, `node-exporter`, `caddy`, `connectivity-checker`, and `hub-poller` services running.

### Step 4.2: Access Services
- **Grafana**: Access Grafana via `https://<NEW_HOST_IP>:8445`.
  - You will see a browser warning because the certificate is self-signed. This is expected. Proceed to the site.
  - Login with user `admin` and the password you set in `.env.monitoring`.
- **Loki**: The Loki API is available at `https://<NEW_HOST_IP>:8446`. This endpoint is protected by Basic Auth.

## 5. Connecting Remote Nodes

For each remote node that needs to send logs and metrics to this monitoring host:

1.  Follow the instructions in the `remote/README.md` file.
2.  Create a `.env` file in the `remote` directory on the monitoring host with credentials:
    ```bash
    INSTANCE_ID=<unique-node-id>
    INSTANCE_IP=<node-ip>
    GF_SERVER_ROOT_IP=<monitoring-host-ip>
    NETWORKNODE_IP=<monitoring-host-ip>
    LOKI_INGEST_PASSWORD=<same-as-monitoring-host>
    PROMETHEUS_PASSWORD=<same-as-monitoring-host>
    ```
3.  Deploy using the script:
    ```bash
    cd remote
    sudo ./deploy-promtail.sh <unique-node-id>
    ```
4.  The script will:
    - Auto-detect GPU availability (enables nvidia-gpu-exporter if present)
    - Configure Grafana Agent to push metrics securely via HTTPS + auth
    - Configure Promtail to push logs via HTTPS + auth
    - Start all services with exporters bound to localhost only

5.  Verify in Grafana:
    - "System Metrics (Node Exporter)" dashboard: Select the remote node from dropdown
    - "Connectivity Monitor" dashboard: Filter by `instance_id`

## 6. Security Notes

- **No firewall rules needed on remote nodes**: All communication is outbound (push-based).
- **Exporters are localhost-only**: node-exporter (9100) and nvidia-gpu-exporter (9835) bind to 127.0.0.1.
- **Authentication required**: All metric and log transmission uses HTTPS + basic auth.
- **Monitoring host ports**: Ensure ports 8446 (Loki) and 8448 (Prometheus) are open for incoming connections.
